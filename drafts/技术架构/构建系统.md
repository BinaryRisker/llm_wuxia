# 构建系统

## mdBook 架构概览

《LLM武侠演义》采用 mdBook 作为核心构建工具，实现从 Markdown 源文件到静态网站的自动化构建。

## 项目结构解析

```
llm_wuxia/
├── book.toml              # mdBook 配置文件
├── src/                   # 源文件目录
│   ├── SUMMARY.md         # 书籍目录结构
│   ├── README.md          # 书籍介绍页
│   ├── 01-第一章-注意力心法现世.md
│   ├── 02-第二章-无极宗初现锋芒.md
│   └── ...               # 其他章节文件
├── theme/                 # 主题定制目录
│   └── css/
│       └── wuxia.css     # 武侠风格样式
├── drafts/               # 设定文档草稿
│   ├── 世界观设定/
│   ├── 内容体系/
│   ├── 技术架构/
│   ├── 部署指南/
│   ├── 贡献指南/
│   └── 附录/
└── README.md             # 项目说明
```

## 配置文件详解

### book.toml 核心配置

```toml
[book]
title = "LLM武侠演义"
description = "AI发展史的武侠化演绎"
authors = ["社区贡献者"]
language = "zh-CN"
multilingual = false
src = "src"

[build]
build-dir = "book"
create-missing = true

[output.html]
theme = "theme"
default-theme = "navy"
preferred-dark-theme = "navy"
smart-punctuation = true
mathjax-support = true
copy-fonts = true
additional-css = ["theme/css/wuxia.css"]

[output.html.search]
enable = true
limit-results = 20
teaser-word-count = 30
use-boolean-and = true
boost-title = 2
boost-hierarchy = 1
boost-paragraph = 1
expand = true
heading-split-level = 2

[output.html.fold]
enable = true
level = 2

[output.html.playground]
editable = false
copy-js = true
line-numbers = true

[output.html.redirect]
# 可以配置重定向规则

[preprocessor.links]
# 启用链接检查预处理器

[preprocessor.index]
# 启用索引预处理器
```

### SUMMARY.md 结构规范

```markdown
# Summary

[介绍](README.md)

---

# 第一部：基础篇

- [第一章：注意力心法现世](01-第一章-注意力心法现世.md)
- [第二章：无极宗初现锋芒](02-第二章-无极宗初现锋芒.md)
- [第三章：博学院的反击](03-第三章-博学院的反击.md)
- [第四章：无极宗GPT第二卷](04-第四章-无极宗GPT第二卷.md)
- [第五章：无极宗GPT第三卷惊世](05-第五章-无极宗GPT第三卷惊世.md)

---

# 第二部：竞争篇

- [第六章：博学院的野心](06-第六章-博学院的野心.md)
- [第七章：脸书派的挑战](07-第七章-脸书派的挑战.md)
- [第八章：英伟达掌门的崛起](08-第八章-英伟达掌门的崛起.md)
- [第九章：无极宗内乱](09-第九章-无极宗内乱.md)
- [第十章：无极宗ChatGPT心法横空出世](10-第十章-无极宗ChatGPT心法横空出世.md)

---

# 附录

- [AI发展时间轴](AI发展时间轴.md)
- [人物关系图谱](人物关系图谱.md)
- [技术术语对照表](技术术语对照表.md)
```

## 构建命令详解

### 本地开发命令

```bash
# 安装 mdBook (需要先安装 Rust)
cargo install mdbook

# 本地实时预览 (支持热重载)
mdbook serve

# 指定端口和地址
mdbook serve --port 3000 --hostname 0.0.0.0

# 仅构建不启动服务器
mdbook build

# 清理构建产物
mdbook clean

# 测试链接有效性
mdbook test
```

### 高级构建选项

```bash
# 使用特定配置文件
mdbook build --config book.toml

# 构建到指定目录
mdbook build --dest-dir custom-output

# 启用详细输出
mdbook build --verbose

# 监视文件变化自动重建
mdbook watch
```

## 预处理器集成

### 链接检查器
自动检查内部链接的有效性，确保章节间引用正确。

```toml
[preprocessor.links]
# 自动生成目录页面
render = true
# 检查外部链接（可选）
check-external-links = false
```

### 自定义预处理器
可以开发自定义预处理器处理特殊需求：

```rust
// 示例：武侠术语自动链接预处理器
use mdbook::preprocess::{Preprocessor, PreprocessorContext};
use mdbook::book::{Book, BookItem, Chapter};

pub struct WuxiaTermLinker;

impl Preprocessor for WuxiaTermLinker {
    fn name(&self) -> &str {
        "wuxia-term-linker"
    }

    fn run(&self, _ctx: &PreprocessorContext, mut book: Book) -> Result<Book, Error> {
        // 自动为武侠术语添加链接
        book.for_each_mut(|item| {
            if let BookItem::Chapter(chapter) = item {
                chapter.content = process_wuxia_terms(&chapter.content);
            }
        });
        Ok(book)
    }
}
```

## 性能优化策略

### 构建性能优化
1. **增量构建**：仅重建变更的文件
2. **并行处理**：利用多核并行构建
3. **缓存机制**：缓存预处理结果

### 运行时性能优化
1. **静态资源优化**：CSS/JS 压缩和合并
2. **图片优化**：自动压缩和格式转换
3. **搜索索引优化**：优化搜索性能

### 部署优化
1. **CDN 加速**：通过 CDN 分发静态资源
2. **Gzip 压缩**：服务器端启用压缩
3. **缓存策略**：合理设置缓存头

## 多语言支持

### 国际化配置
```toml
[book]
language = "zh-CN"
multilingual = false

# 如需支持多语言
[book.multilingual]
enabled = true

[book.languages.zh-CN]
title = "LLM武侠演义"

[book.languages.en]
title = "LLM Martial Arts Epic"
```

### 语言文件组织
```
src/
├── zh-CN/          # 中文版本
│   ├── SUMMARY.md
│   └── chapters/
├── en/             # 英文版本
│   ├── SUMMARY.md
│   └── chapters/
└── LANGS.md        # 语言配置
```

## 插件生态

### 常用插件
1. **mdbook-mermaid**：支持 Mermaid 图表
2. **mdbook-katex**：支持数学公式
3. **mdbook-linkcheck**：链接检查
4. **mdbook-toc**：自动生成目录
5. **mdbook-epub**：生成 EPUB 格式

### 插件安装和配置
```bash
# 安装 Mermaid 插件
cargo install mdbook-mermaid

# 在 book.toml 中配置
[preprocessor.mermaid]
command = "mdbook-mermaid"

[output.html]
additional-js = ["mermaid.min.js", "mermaid-init.js"]
```

## 开发工具集成

### VS Code 集成
推荐扩展：
- **Markdown All in One**：Markdown 编辑支持
- **mdBook**：mdBook 项目支持
- **Markdown Preview Enhanced**：增强预览功能

### Git 钩子集成
```bash
#!/bin/sh
# pre-commit hook: 构建前检查
mdbook test
if [ $? -ne 0 ]; then
    echo "mdBook test failed!"
    exit 1
fi
```

## 故障排除

### 常见问题解决

1. **构建失败**
   - 检查 Markdown 语法
   - 验证文件路径
   - 查看详细错误信息

2. **链接断开**
   - 运行 `mdbook test`
   - 检查相对路径
   - 验证文件存在性

3. **样式异常**
   - 清理缓存重新构建
   - 检查 CSS 语法
   - 验证资源路径

4. **性能问题**
   - 减少大文件
   - 优化图片尺寸
   - 启用构建缓存

### 调试工具
```bash
# 启用详细日志
RUST_LOG=debug mdbook build

# 检查配置
mdbook --version
mdbook check

# 性能分析
mdbook build --timing
```

## 最佳实践

### 文件组织
1. **命名规范**：使用一致的文件命名规则
2. **目录结构**：保持清晰的目录层次
3. **资源管理**：集中管理图片和资源文件

### 内容管理
1. **版本控制**：使用 Git 管理版本
2. **协作流程**：建立清晰的协作规范
3. **质量保证**：定期检查和测试

### 维护策略
1. **定期更新**：保持工具链更新
2. **性能监控**：监控构建和访问性能
3. **备份恢复**：建立备份和恢复机制

这套构建系统设计充分考虑了项目的特点和需求，既保持了技术的先进性，又确保了使用的便利性，为《LLM武侠演义》的持续发展提供了坚实的技术基础。